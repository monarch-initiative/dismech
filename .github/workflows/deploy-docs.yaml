---
name: Validate Schema Docs Build
on:  # yamllint disable-line rule:truthy
  push:
    branches: [main]
    paths:
      - 'src/dismech/schema/**'
      - 'mkdocs.yml'
      - 'docs/**'
      - 'justfile'
      - 'project.justfile'
  workflow_dispatch:

permissions: {}

jobs:
  build-docs:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      # https://github.com/actions/checkout
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      # https://github.com/astral-sh/setup-uv
      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          python-version: 3.13
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      # https://github.com/actions/setup-python
      - name: Set up Python
        uses: actions/setup-python@v6.2.0
        with:
          python-version: 3.13

      - name: Install just
        run: |
          uv tool install rust-just

      - name: Install dependencies
        run: uv sync --dev --no-progress

      - name: Generate schema docs static pages
        run: |
          just gen-schema-docs

      - name: Ensure generated schema docs are committed
        run: |
          if ! git diff --quiet elements/; then
            echo "Generated schema docs are out of date. Run: just gen-schema-docs"
            git diff --stat elements/
            exit 1
          fi
