<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ disease_a_label }} <-> {{ disease_b_label }} - Comorbidity</title>
    <style>
        :root {
            --primary: #0f766e;
            --primary-light: #14b8a6;
            --primary-dark: #0d5c56;
            --secondary: #6366f1;
            --bg: #f0fdfa;
            --card-bg: #ffffff;
            --text: #134e4a;
            --text-muted: #5f7a78;
            --border: #ccfbf1;
            --accent-orange: #f59e0b;
            --accent-rose: #f43f5e;
            --accent-violet: #8b5cf6;
            --accent-sky: #0ea5e9;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.7;
        }

        a {
            color: var(--primary-dark);
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }

        .internal-link {
            text-decoration: underline;
            text-underline-offset: 2px;
            text-decoration-thickness: 1px;
        }

        .internal-link:hover {
            text-decoration-thickness: 2px;
        }

        .dismech-inline-link {
            margin-left: 6px;
            font-size: 0.78rem;
            font-weight: 600;
            color: #0369a1;
            text-decoration: underline;
            text-underline-offset: 2px;
            text-decoration-thickness: 1px;
            white-space: nowrap;
        }

        .dismech-inline-link:hover {
            text-decoration-thickness: 2px;
        }

        .curation-gap-badge {
            display: inline-flex;
            align-items: center;
            margin-left: 8px;
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 0.72rem;
            font-weight: 700;
            letter-spacing: 0.01em;
            text-transform: uppercase;
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #b91c1c;
            vertical-align: middle;
        }

        .missing-ontology-link {
            color: #b91c1c !important;
            text-decoration: underline dotted;
            text-underline-offset: 2px;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 24px;
        }

        /* Header */
        .page-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 40px 32px;
            border-radius: 16px;
            margin-bottom: 24px;
            position: relative;
            overflow: hidden;
        }

        .page-header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -20%;
            width: 400px;
            height: 400px;
            background: rgba(255,255,255,0.05);
            border-radius: 50%;
        }

        .page-header h1 {
            font-size: 2.1rem;
            font-weight: 700;
            margin-bottom: 12px;
            position: relative;
        }

        .header-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
            position: relative;
        }

        .header-subtitle {
            margin-top: 12px;
            color: rgba(255,255,255,0.85);
            position: relative;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .badge-category {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        .badge-mondo {
            background: var(--accent-sky);
            color: white;
        }

        /* Navigation */
        .breadcrumb {
            margin-bottom: 16px;
            font-size: 0.9rem;
        }

        .breadcrumb a {
            color: var(--primary);
            text-decoration: none;
        }

        .breadcrumb a:hover {
            text-decoration: underline;
        }

        .breadcrumb span {
            color: var(--text-muted);
        }

        /* Cards */
        .card {
            background: var(--card-bg);
            border-radius: 12px;
            border: 1px solid var(--border);
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--border);
        }

        .card-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: 700;
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text);
        }

        .section-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
        }

        /* Tags */
        .tag-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .tag {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .tag-parent {
            background: #e0e7ff;
            color: #3730a3;
        }

        .tag-classification {
            background: #fef3c7;
            color: #92400e;
        }

        .tag-mechanistic {
            background: #dbeafe;
            color: #1e40af;
        }

        .tag-accent {
            background: #ede9fe;
            color: #5b21b6;
        }

        .mapping-section {
            margin-bottom: 16px;
        }

        .mapping-item {
            padding: 10px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background: #ffffff;
            margin-bottom: 10px;
        }

        .mapping-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .mapping-notes {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-top: 6px;
        }

        .field {
            margin-top: 6px;
        }

        .field-label {
            font-weight: 600;
            margin-right: 6px;
        }

        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 10px;
            margin-top: 8px;
        }

        .metric {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 8px 10px;
            font-size: 0.9rem;
        }

        .evidence {
            margin-top: 8px;
        }

        .evidence-item {
            border-left: 3px solid #94a3b8;
            padding-left: 10px;
            margin: 8px 0;
            color: var(--text-muted);
        }

        .evidence-item strong {
            color: var(--text);
        }

        .go-terms {
            margin: 8px 0 0;
            padding-left: 18px;
        }

        details {
            margin-top: 12px;
        }

        pre {
            background: #0f172a;
            color: #e2e8f0;
            padding: 12px;
            border-radius: 10px;
            overflow-x: auto;
            font-size: 0.85rem;
        }

        /* Mermaid graph */
        .mermaid-container {
            text-align: center;
            margin: 20px 0;
            padding: 20px;
            background: white;
            border-radius: 8px;
            border: 1px solid var(--border);
            overflow-x: auto;
        }

        .mermaid svg {
            max-width: 100%;
            height: auto;
        }

        @media (max-width: 720px) {
            .page-header {
                padding: 28px 20px;
            }

            .page-header h1 {
                font-size: 1.7rem;
            }

            .section-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default',
            flowchart: {
                htmlLabels: true,
                curve: 'basis'
            }
        });
    </script>
</head>
<body>
    {% macro render_evidence(evidence_list) %}
    {% if evidence_list %}
    <div class="evidence">
        {% for ev in evidence_list %}
        <div class="evidence-item">
            <div>
                {% if ev.reference %}
                <strong><a href="{{ ev.reference | curie_to_url }}" target="_blank">{{ ev.reference }}</a></strong>
                {% else %}
                <strong>Evidence</strong>
                {% endif %}
                {% if ev.supports %} ({{ ev.supports }}){% endif %}
            </div>
            {% if ev.evidence_source %}
            <div>Source: {{ ev.evidence_source }}</div>
            {% endif %}
            {% if ev.snippet %}
            <div>"{{ ev.snippet }}"</div>
            {% endif %}
            {% if ev.explanation %}
            <div>{{ ev.explanation }}</div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    {% endif %}
    {% endmacro %}

    {% macro render_term_link(term_id, label=None, include_gap_badge=True) %}
    {% if term_id %}
    {% set is_mondo = term_id.startswith('MONDO:') %}
    {% set has_local_page = (term_id | has_local_disorder_page) if is_mondo else False %}
    {% set dismech_href = (term_id | dismech_page_url) if is_mondo else None %}
    <a href="{{ term_id | curie_to_url }}" target="_blank"{% if is_mondo and not has_local_page %} class="missing-ontology-link"{% endif %}>{{ label or term_id }}</a>
    {% if dismech_href %}
    <a class="dismech-inline-link" href="{{ dismech_href }}">dismech</a>
    {% elif is_mondo and include_gap_badge %}
    <span class="curation-gap-badge">Not Yet Curated</span>
    {% endif %}
    {% endif %}
    {% endmacro %}

    <div class="container">
        <nav class="breadcrumb">
            <a href="../../app/index.html">Browse All</a>
            <span> / </span>
            <span>Comorbidity</span>
        </nav>

        <header class="page-header">
            <h1>{{ disease_a_label }} <-> {{ disease_b_label }}</h1>
            <div class="header-meta">
                <span class="badge badge-category">Comorbidity</span>
                {% if comorbidity.directionality %}
                <span class="badge badge-mondo">{{ comorbidity.directionality }}</span>
                {% endif %}
                {% if comorbidity.curation_status %}
                <span class="badge badge-category">{{ comorbidity.curation_status }}</span>
                {% endif %}
            </div>
            {% if comorbidity.notes %}
            <div class="header-subtitle">{{ comorbidity.notes }}</div>
            {% endif %}
        </header>

        <div class="section-grid">
            <div class="card">
                <div class="card-header">
                    <div class="card-icon" style="background: #e0f2fe; color: #0369a1;">A</div>
                    <h2 class="card-title">Disease A</h2>
                </div>
                <div class="mapping-title">
                    {% set disease_a_href = disease_a_slug | dismech_slug_page_url if disease_a_slug else None %}
                    {% if disease_a_href %}
                    <a class="internal-link" href="{{ disease_a_href }}">{{ disease_a_label }}</a>
                    {% else %}
                    {{ disease_a_label }}
                    {% endif %}
                </div>
                {% if disease_a_slug %}
                <div class="field"><span class="field-label">Slug:</span>{{ disease_a_slug }}</div>
                {% endif %}
                {% if comorbidity.disease_a and comorbidity.disease_a.composition %}
                <div class="field"><span class="field-label">Composition:</span>{{ comorbidity.disease_a.composition }}</div>
                {% endif %}
                {% if comorbidity.disease_a and comorbidity.disease_a.components %}
                <div class="field"><span class="field-label">Components:</span>
                    <div class="tag-list">
                        {% for component in comorbidity.disease_a.components %}
                        {% if component.slug %}
                        {% set component_href = component.slug | dismech_slug_page_url %}
                        <span class="tag tag-parent">{% if component_href %}<a class="internal-link" href="{{ component_href }}">{{ component.slug }}</a>{% else %}{{ component.slug }}{% endif %}</span>
                        {% endif %}
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
            <div class="card">
                <div class="card-header">
                    <div class="card-icon" style="background: #ede9fe; color: #6d28d9;">B</div>
                    <h2 class="card-title">Disease B</h2>
                </div>
                <div class="mapping-title">
                    {% set disease_b_href = disease_b_slug | dismech_slug_page_url if disease_b_slug else None %}
                    {% if disease_b_href %}
                    <a class="internal-link" href="{{ disease_b_href }}">{{ disease_b_label }}</a>
                    {% else %}
                    {{ disease_b_label }}
                    {% endif %}
                </div>
                {% if disease_b_slug %}
                <div class="field"><span class="field-label">Slug:</span>{{ disease_b_slug }}</div>
                {% endif %}
                {% if comorbidity.disease_b and comorbidity.disease_b.composition %}
                <div class="field"><span class="field-label">Composition:</span>{{ comorbidity.disease_b.composition }}</div>
                {% endif %}
                {% if comorbidity.disease_b and comorbidity.disease_b.components %}
                <div class="field"><span class="field-label">Components:</span>
                    <div class="tag-list">
                        {% for component in comorbidity.disease_b.components %}
                        {% if component.slug %}
                        {% set component_href = component.slug | dismech_slug_page_url %}
                        <span class="tag tag-parent">{% if component_href %}<a class="internal-link" href="{{ component_href }}">{{ component.slug }}</a>{% else %}{{ component.slug }}{% endif %}</span>
                        {% endif %}
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        {% if disease_a_graphs or disease_b_graphs %}
        <div class="card" id="causal-graphs">
            <div class="card-header">
                <div class="card-icon" style="background: #e0e7ff; color: #4f46e5;">G</div>
                <h2 class="card-title">Causal Mechanism Graphs</h2>
            </div>
            {% for g in disease_a_graphs %}
            <h3>{{ g.label }}</h3>
            <div class="mermaid-container">
                <pre class="mermaid">{{ g.mermaid_code }}</pre>
            </div>
            {% endfor %}
            {% for g in disease_b_graphs %}
            <h3>{{ g.label }}</h3>
            <div class="mermaid-container">
                <pre class="mermaid">{{ g.mermaid_code }}</pre>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        {% if comorbidity.association_signals %}
        <div class="card" id="signals">
            <div class="card-header">
                <div class="card-icon" style="background: #fef3c7; color: #d97706;">S</div>
                <h2 class="card-title">Association Signals</h2>
            </div>
            <div class="mapping-section">
                {% for signal in comorbidity.association_signals %}
                <div class="mapping-item">
                    <div class="mapping-title">Signal {{ loop.index }}</div>
                    <div class="tag-list" style="margin-bottom: 8px;">
                        {% if signal.source %}<span class="tag tag-parent">{{ signal.source }}</span>{% endif %}
                        {% if signal.method %}<span class="tag tag-classification">{{ signal.method }}</span>{% endif %}
                        {% if signal.directionality %}<span class="tag tag-mechanistic">{{ signal.directionality }}</span>{% endif %}
                    </div>
                    {% if signal.population %}<div class="field"><span class="field-label">Population:</span>{{ signal.population }}</div>{% endif %}
                    {% if signal.demographics %}
                    <div class="field"><span class="field-label">Demographics:</span>
                        {% if signal.demographics.sex %}Sex {{ signal.demographics.sex }}{% endif %}
                        {% if signal.demographics.age_range %}{% if signal.demographics.sex %}, {% endif %}Age {{ signal.demographics.age_range }}{% endif %}
                    </div>
                    {% endif %}
                    {% if signal.signal_disorder_a_id or signal.signal_disorder_b_id %}
                    <div class="field"><span class="field-label">Signal IDs:</span>
                        {% if signal.signal_disorder_a_id %}
                        {{ render_term_link(signal.signal_disorder_a_id) }}
                        {% endif %}
                        {% if signal.signal_disorder_b_id %}
                        {% if signal.signal_disorder_a_id %} -> {% endif %}
                        {{ render_term_link(signal.signal_disorder_b_id) }}
                        {% endif %}
                    </div>
                    {% endif %}
                    {% if signal.mapping_notes %}
                    <div class="mapping-notes"><span class="field-label">Mapping notes:</span>{{ signal.mapping_notes }}</div>
                    {% endif %}
                    {% if signal.a_before_b is not none or signal.b_before_a is not none or signal.same_time is not none %}
                    <div class="field"><span class="field-label">Temporal:</span>
                        {% if signal.a_before_b is not none %}A before B: {{ signal.a_before_b }}{% endif %}
                        {% if signal.b_before_a is not none %}{% if signal.a_before_b is not none %}, {% endif %}B before A: {{ signal.b_before_a }}{% endif %}
                        {% if signal.same_time is not none %}{% if signal.a_before_b is not none or signal.b_before_a is not none %}, {% endif %}Same time: {{ signal.same_time }}{% endif %}
                    </div>
                    {% endif %}

                    {% set metrics = (signal.metrics or []) + ((signal.statistics.metrics) if signal.statistics and signal.statistics.metrics else []) %}
                    {% if metrics %}
                    <div class="metrics">
                        {% for metric in metrics %}
                        <div class="metric">
                            <div><strong>{{ metric.metric_type }}</strong>: {{ metric.metric_value }}</div>
                            {% if metric.metric_ci_lower is not none and metric.metric_ci_upper is not none %}
                            <div>CI: {{ metric.metric_ci_lower }} - {{ metric.metric_ci_upper }}</div>
                            {% endif %}
                            {% if metric.p_value is not none %}<div>p: {{ metric.p_value }}</div>{% endif %}
                            {% if metric.fdr is not none %}<div>FDR: {{ metric.fdr }}</div>{% endif %}
                            {% if metric.notes %}<div>{{ metric.notes }}</div>{% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}

                    {% if signal.statistics and signal.statistics.evidence %}
                    {{ render_evidence(signal.statistics.evidence) }}
                    {% endif %}
                    {% if signal.evidence %}
                    {{ render_evidence(signal.evidence) }}
                    {% endif %}

                    {% if signal.go_enrichment and signal.go_enrichment.go_terms %}
                    <div class="field"><span class="field-label">GO enrichment:</span>{{ signal.go_enrichment.description }}</div>
                    <ul class="go-terms">
                        {% for term in signal.go_enrichment.go_terms %}
                        <li>
                            {% if term.term %}
                            {{ render_term_link(term.term.id, term.term.label or term.term.id) }}
                            {% endif %}
                            {% if term.fdr is not none %} (FDR {{ term.fdr }}){% endif %}
                        </li>
                        {% endfor %}
                    </ul>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        {% if comorbidity.hypotheses %}
        <div class="card" id="hypotheses">
            <div class="card-header">
                <div class="card-icon" style="background: #dbeafe; color: #1e40af;">H</div>
                <h2 class="card-title">Hypotheses</h2>
            </div>
            {% for hypothesis in comorbidity.hypotheses %}
            <div class="mapping-item">
                <div class="field">{{ hypothesis.description }}</div>
                {{ render_evidence(hypothesis.evidence) }}
                {% if hypothesis.pathophysiology %}
                <div class="field"><span class="field-label">Pathophysiology:</span></div>
                {% for patho in hypothesis.pathophysiology %}
                <div class="field">
                    <strong>{{ patho.name }}</strong>: {{ patho.description }}
                </div>
                {% if patho.cell_types %}
                <div class="field">
                    <span class="field-label">Cell types:</span>
                    <div class="tag-list">
                        {% for ct in patho.cell_types %}
                        {% if ct.term and ct.term.id %}
                        <span class="tag tag-parent">
                            {{ render_term_link(ct.term.id, ct.term.label or ct.preferred_term or ct.term.id) }}
                        </span>
                        {% else %}
                        <span class="tag tag-parent">{{ ct.preferred_term }}</span>
                        {% endif %}
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                {% if patho.biological_processes %}
                <div class="field">
                    <span class="field-label">Biological processes:</span>
                    <div class="tag-list">
                        {% for bp in patho.biological_processes %}
                        {% if bp.term and bp.term.id %}
                        <span class="tag tag-classification">
                            {{ render_term_link(bp.term.id, bp.term.label or bp.preferred_term or bp.term.id) }}
                        </span>
                        {% else %}
                        <span class="tag tag-classification">{{ bp.preferred_term }}</span>
                        {% endif %}
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                {% if patho.gene_products %}
                <div class="field">
                    <span class="field-label">Gene products:</span>
                    <div class="tag-list">
                        {% for gp in patho.gene_products %}
                        {% if gp.term and gp.term.id %}
                        <span class="tag tag-mechanistic">
                            {{ render_term_link(gp.term.id, gp.term.label or gp.preferred_term or gp.term.id) }}
                        </span>
                        {% else %}
                        <span class="tag tag-mechanistic">{{ gp.preferred_term }}</span>
                        {% endif %}
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                {% if patho.mechanisms %}
                <div class="field">
                    <span class="field-label">Mechanisms:</span>
                    <div class="tag-list">
                        {% for mech in patho.mechanisms %}
                        <span class="tag tag-accent">{{ mech }}</span>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                {{ render_evidence(patho.evidence) }}
                {% if patho.notes %}
                <div class="mapping-notes">{{ patho.notes }}</div>
                {% endif %}
                {% endfor %}
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% endif %}

        {% if comorbidity.shared_upstream_hypotheses %}
        <div class="card" id="upstream">
            <div class="card-header">
                <div class="card-icon" style="background: #ccfbf1; color: #0f766e;">U</div>
                <h2 class="card-title">Shared Upstream Hypotheses</h2>
            </div>
            {% for upstream in comorbidity.shared_upstream_hypotheses %}
            <div class="mapping-item">
                {% if upstream.upstream_disorder %}
                <div class="field"><span class="field-label">Upstream:</span>{{ upstream.upstream_disorder }}</div>
                {% endif %}
                {% if upstream.description %}
                <div class="field">{{ upstream.description }}</div>
                {% endif %}
                {{ render_evidence(upstream.evidence) }}
            </div>
            {% endfor %}
        </div>
        {% endif %}

        {% if comorbidity.phenotypes %}
        <div class="card" id="phenotypes">
            <div class="card-header">
                <div class="card-icon" style="background: #fce7f3; color: #9d174d;">P</div>
                <h2 class="card-title">Shared Phenotypes</h2>
            </div>
            <ul class="go-terms">
                {% for pheno in comorbidity.phenotypes %}
                <li>
                    {% if pheno.phenotype_term and pheno.phenotype_term.term and pheno.phenotype_term.term.id %}
                    {{ render_term_link(pheno.phenotype_term.term.id, pheno.phenotype_term.term.label or pheno.name or pheno.preferred_term) }}
                    {% else %}
                    {{ pheno.name or pheno.preferred_term }}
                    {% endif %}
                </li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        <div class="card">
            <div class="card-header">
                <div class="card-icon" style="background: #e2e8f0; color: #334155;">Y</div>
                <h2 class="card-title">Raw YAML</h2>
            </div>
            <details>
                <summary>Show YAML</summary>
                <pre>{{ yaml_content }}</pre>
            </details>
            {% if source_file %}
            <div class="field"><span class="field-label">Source:</span><a href="{{ source_file }}" target="_blank">GitHub</a></div>
            {% endif %}
        </div>
    </div>
</body>
</html>
